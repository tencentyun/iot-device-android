* [OTA设备固件升级](#OTA设备固件升级)
  * [固件升级简介](#固件升级简介)
  * [运行示例程序体验检查固件更新功能](#运行示例程序体验检查固件更新功能)

# OTA设备固件升级
## 固件升级简介
设备固件升级又称 OTA，是物联网通信服务的重要组成部分。当物联设备有新功能或者需要修复漏洞时，设备可以通过 OTA 服务快速进行固件升级。请参考官网文档 控制台使用手册 [固件升级](https://cloud.tencent.com/document/product/634/14673)

体验固件升级需要在控制台中添加新的固件，请参考官网文档 开发者手册 [设备固件升级](https://cloud.tencent.com/document/product/634/14674)

## 运行示例程序体验检查固件更新功能

请先按照 [基于TCP的MQTT设备接入](../docs/基于TCP的MQTT设备接入.md) 的步骤，将设备 连接MQTT 进行认证接入。

运行 [MqttSample.java](../src/test/java/MqttSample.java) 的main函数，设备上线后调用checkFirmware()，将上报固件版本号检查是否有固件更新。示例代码如下：
```
private static void checkFirmware() {
    try {
        Thread.sleep(2000);
        String workDir = System.getProperty("user.dir") + "/explorer/explorer-device-java/src/test/resources/";
        mqttconnection.initOTA(workDir, new TXOTACallBack() {
        	@Override
            public void onReportFirmwareVersion(int resultCode, String version, String resultMsg) {
                LOG.error("onReportFirmwareVersion:" + resultCode + ", version:" + version + ", resultMsg:" + resultMsg);
            }
            
            @Override
            public boolean onLastestFirmwareReady(String url, String md5, String version) {
                LOG.error("MQTTSample onLastestFirmwareReady");
                return false;
            }
            
            @Override
            public void onDownloadProgress(int percent, String version) {
                LOG.error("onDownloadProgress:" + percent);
            }
            
            @Override
            public void onDownloadCompleted(String outputFile, String version) {
                LOG.error("onDownloadCompleted:" + outputFile + ", version:" + version);
            
                mqttconnection.reportOTAState(TXOTAConstansts.ReportState.DONE, 0, "OK", version);
            }
            
            @Override
            public void onDownloadFailure(int errCode, String version) {
                LOG.error("onDownloadFailure:" + errCode);
            
                mqttconnection.reportOTAState(TXOTAConstansts.ReportState.FAIL, errCode, "FAIL", version);
            }
        });
        mqttconnection.reportCurrentFirmwareVersion("0.0.1");
    } catch (InterruptedException e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
    }
}
```

以下是设备成功订阅 OTA 升级的 Topic 主题 和 上报当前版本号 的logcat日志，示例中的版本号version传入的值为0.0.1。
```
08/03/2021 09:22:35,772 [main] INFO  TXMqttConnection subscribe 739  - Starting subscribe topic: $ota/update/AP9ZLEVFKT/log_test
08/03/2021 09:22:35,792 [MQTT Call: AP9ZLEVFKTlog_test] DEBUG MqttSample onSubscribeCompleted 283  - onSubscribeCompleted, status[OK], topics[[$ota/update/AP9ZLEVFKT/log_test]], userContext[], errMsg[subscribe success]
onSubscribeCompleted status OK
08/03/2021 09:22:35,775 [main] INFO  TXMqttConnection publish 557  - Starting publish topic: $ota/report/AP9ZLEVFKT/log_test Message: {"report":{"version":"0.0.1"},"type":"report_version"}
08/03/2021 09:22:35,787 [MQTT Call: AP9ZLEVFKTlog_test] DEBUG MqttSample onPublishCompleted 271  - onPublishCompleted, status[OK], topics[[$ota/report/AP9ZLEVFKT/log_test]],  userContext[], errMsg[publish success]
```

当在控制台中触发固件升级操作后，设备端会通过订阅的 OTA 升级的 Topic $ota/update/${productID}/${deviceName} 收到固件升级的消息

```
08/03/2021 09:26:46,533 [MQTT Call: AP9ZLEVFKTlog_test] INFO  TXMqttConnection messageArrived 1119  - Received topic: $ota/update/AP9ZLEVFKT/log_test, id: 0, message: {"file_size":234775,"md5sum":"f2f1b3317d4f1ef7f512bfae5050563b","type":"update_firmware","url":"https://ota-1255858890.cos.ap-guangzhou.myqcloud.com/100012619289_AP9ZLEVFKT_0.0.2?sign=q-sign-algorithm%3Dsha1%26q-ak%3DAKIDdO8ldrUa0Uts4H5Gzx6FZ9nfedjpiCd7%26q-sign-time%3D1615166805%3B1615253205%26q-key-time%3D1615166805%3B1615253205%26q-header-list%3D%26q-url-param-list%3D%26q-signature%3Dab097eb0bc3679e4cd3346e720dd2c1409090884","version":"0.0.2"}
08/03/2021 09:26:46,540 [Thread-2] DEBUG TXOTAImpl run 513  - fileLength 0 bytes
08/03/2021 09:26:46,541 [Thread-2] DEBUG TXOTAImpl run 522  - connect: https://ota-1255858890.cos.ap-guangzhou.myqcloud.com/100012619289_AP9ZLEVFKT_0.0.2?sign=q-sign-algorithm%3Dsha1%26q-ak%3DAKIDdO8ldrUa0Uts4H5Gzx6FZ9nfedjpiCd7%26q-sign-time%3D1615166805%3B1615253205%26q-key-time%3D1615166805%3B1615253205%26q-header-list%3D%26q-url-param-list%3D%26q-signature%3Dab097eb0bc3679e4cd3346e720dd2c1409090884
08/03/2021 09:26:46,590 [Thread-2] INFO  TXOTAImpl checkServerTrusted 446  - checkServerTrusted OK!!!
08/03/2021 09:26:46,644 [Thread-2] DEBUG TXOTAImpl run 532  - totalLength 234775 bytes
08/03/2021 09:26:46,645 [Thread-2] DEBUG TXOTAImpl run 555  - download 7789 bytes. percent:3
08/03/2021 09:26:46,706 [Thread-2] DEBUG TXOTAImpl run 555  - download 130581 bytes. percent:55
08/03/2021 09:26:46,742 [Thread-2] DEBUG TXOTAImpl run 555  - download 234775 bytes. percent:100
08/03/2021 09:26:46,751 [Thread-2] INFO  TXMqttConnection publish 557  - Starting publish topic: $ota/report/AP9ZLEVFKT/log_test Message: {"report":{"progress":{"result_msg":"OK","result_code":"0","state":"done"},"version":"0.0.2"},"type":"report_progress"}
08/03/2021 09:26:46,752 [MQTT Call: AP9ZLEVFKTlog_test] DEBUG MqttSample onPublishCompleted 271  - onPublishCompleted, status[OK], topics[[$ota/report/AP9ZLEVFKT/log_test]],  userContext[], errMsg[publish success]
```
以上日志为 收到固件升级的消息 ，下载并显示下载进度，下载新版本固件成功后，上报最新的版本号，此时示例中上报的最新版本号version为0.0.2。




